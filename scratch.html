<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åˆ®åˆ®ä¹ Â· Scratch Card</title>
  <style>
    :root{--bg:#0f1724;--card:#1b2430;--accent:#ffd166;--muted:#93a3b6}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#081226,#071022);color:#e8f0ff;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{width:420px;padding:28px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 8px;font-size:18px}
    p{margin:0 0 16px;color:var(--muted);font-size:13px}
    .card{position:relative;background:linear-gradient(180deg,#0f1724,#0b1220);border-radius:8px;padding:18px;color:#fff;overflow:hidden}
    .prize{min-height:100px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700}
    canvas{position:absolute;inset:0;width:100%;height:100%;border-radius:8px;touch-action:none}
    .controls{display:flex;gap:8px;margin-top:12px}
    .btn{background:rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .btn.primary{background:linear-gradient(90deg,#ff9f1c,#ffd166);color:#0b1220;font-weight:700}
    .status{margin-top:10px;color:var(--muted);font-size:13px}
    .hint{margin-top:8px;font-size:12px;color:#9fb3c8}
    @media (max-width:480px){.wrap{width:92vw;padding:18px}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>åˆ®åˆ®ä¹</h1>
    <p>ç”¨é¼ æ ‡æˆ–æ‰‹æŒ‡æ¥åˆ®å¼€è¦†ç›–å±‚ï¼Œçœ‹çœ‹èƒ½å¦åˆ®ä¸­å¤§å¥–ï¼</p>
    <div class="card" id="card">
      <div class="prize" id="prize">ğŸ‰ æ­å–œï¼ä¸­å¥–ï¼š<span id="prizeText">å¾…æ­æ™“</span></div>
      <canvas id="mask"></canvas>
    </div>
    <div class="controls">
      <button class="btn" id="reset">é‡æ–°ç”Ÿæˆ</button>
      <button class="btn primary" id="reveal">ç«‹å³æ­æ™“</button>
    </div>
    <div class="status" id="status">å·²åˆ®å¼€ï¼š0%</div>
    <div class="hint">æç¤ºï¼šé€šè¿‡æ»‘åŠ¨æˆ–ç‚¹å‡»å¹¶ç§»åŠ¨æ¥åˆ®å¼€è¦†ç›–å±‚ï¼Œè¾¾åˆ° 60% åè‡ªåŠ¨æ­ç¤ºå…¨éƒ¨ã€‚</div>
  </div>

  <script>
    // å¯é…ç½®å¥–é¡¹ï¼ˆæ–‡æœ¬æˆ– Emojiï¼‰
    const PRIZES = [
      'å†æ¥å†å‰ï¼šå…è´¹å’–å•¡ä¸€æ¯ â˜•',
      'å¹¸è¿å¥–ï¼šä¼˜æƒ åˆ¸ 10% ğŸŸï¸',
      'äºŒç­‰å¥–ï¼šä»·å€¼ 50 å…ƒä»£é‡‘åˆ¸ ğŸ’³',
      'ä¸€ç­‰å¥–ï¼šæ™ºèƒ½æ‰‹è¡¨ ğŸ',
      'ç‰¹ç­‰å¥–ï¼šMacBook Pro ğŸ’»',
      'æ‘¸åˆ°ç©ºç™½ï¼šå†è¯•ä¸€æ¬¡ ğŸ˜Š'
    ];

    // å…ƒç´ 
    const prizeText = document.getElementById('prizeText');
    const canvas = document.getElementById('mask');
    const card = document.getElementById('card');
    const status = document.getElementById('status');
    const resetBtn = document.getElementById('reset');
    const revealBtn = document.getElementById('reveal');

    // éšæœºé€‰é¡¹
    function pickPrize(){
      const p = PRIZES[Math.floor(Math.random()*PRIZES.length)];
      prizeText.textContent = p;
    }

    // ç”»å¸ƒä¸é®ç½©
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let revealed = false;

    function resizeCanvas(){
      // ä½¿ canvas ä¸å¡ç‰‡å°ºå¯¸ä¸€è‡´ï¼ˆè€ƒè™‘ devicePixelRatioï¼‰
      const rect = card.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      ctx.scale(dpr, dpr);
      fillMask();
    }

    function fillMask(){
      // æ¶‚æ»¡ä¸€å±‚é‡‘å±é“ç°+çº¹ç†ï¼Œè¦†ç›–å¥–é¡¹
      const w = canvas.width / (window.devicePixelRatio || 1);
      const h = canvas.height / (window.devicePixelRatio || 1);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // é“¶è‰²æ¸å˜
      const g = ctx.createLinearGradient(0,0,w, h);
      g.addColorStop(0,'#bfc7cc');
      g.addColorStop(0.5,'#9da5aa');
      g.addColorStop(1,'#bfc7cc');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      // é¡¶éƒ¨çº¹ç† - å¾®å°å™ªç‚¹
      const imgData = ctx.getImageData(0,0,w,h);
      for(let i=0;i<imgData.data.length;i+=4){
        const v = Math.random() * 20 - 10;
        imgData.data[i] = Math.max(180, Math.min(255, imgData.data[i] + v));
        imgData.data[i+1] = Math.max(180, Math.min(255, imgData.data[i+1] + v));
        imgData.data[i+2] = Math.max(180, Math.min(255, imgData.data[i+2] + v));
      }
      ctx.putImageData(imgData,0,0);

      // æ–‡å­—æç¤º
      ctx.fillStyle = 'rgba(20,20,20,0.12)';
      ctx.font = 'bold 18px system-ui,Segoe UI,Roboto';
      ctx.textAlign = 'center';
      ctx.fillText('åˆ®å¼€æ­¤å¤„', w/2, h/2 - 8);
      ctx.font = '14px system-ui,Segoe UI,Roboto';
      ctx.fillText('æœ‰æœºä¼šæŠ½ä¸­å¤§å¥–', w/2, h/2 + 14);

      // å°†å¤åˆæ¨¡å¼è®¾ç½®ä¸º 'destination-out' æ—¶ç»˜åˆ¶çš„å†…å®¹ä¼šå˜ä¸ºé€æ˜
      ctx.globalCompositeOperation = 'destination-out';
    }

    function pointerDown(e){
      if(revealed) return;
      drawing = true;
      draw(e);
    }
    function pointerUp(){
      drawing = false;
      // è®¡ç®—å·²åˆ®å¼€æ¯”ä¾‹
      setTimeout(checkReveal, 50);
    }
    function getLocalPos(e){
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX ?? (e.touches && e.touches[0].clientX)) - rect.left;
      const y = (e.clientY ?? (e.touches && e.touches[0].clientY)) - rect.top;
      return {x,y};
    }

    function draw(e){
      if(!drawing || revealed) return;
      e.preventDefault();
      const p = getLocalPos(e);
      ctx.beginPath();
      ctx.fillStyle = 'rgba(0,0,0,1)';
      // ä½¿ç”¨åœ†å½¢åˆ·å­ï¼Œä¿è¯è§¦æ‘¸ä¸é¼ æ ‡æµç•…
      ctx.arc(p.x, p.y, 22, 0, Math.PI*2);
      ctx.fill();
    }

    function checkReveal(){
      // è®¡ç®—é€æ˜åƒç´ å æ¯”
      const w = canvas.width / (window.devicePixelRatio || 1);
      const h = canvas.height / (window.devicePixelRatio || 1);
      try{
        const img = ctx.getImageData(0,0,w,h);
        let cleared = 0;
        for(let i=3;i<img.data.length;i+=4){
          if(img.data[i] === 0) cleared++;
        }
        const total = (img.data.length/4);
        const pct = Math.round((cleared/total)*100);
        status.textContent = `å·²åˆ®å¼€ï¼š${pct}%`;
        if(pct >= 60){
          revealAll();
        }
      }catch(err){
        // è¯»å–åƒç´ å¯èƒ½è¢«å®‰å…¨ç­–ç•¥é™åˆ¶ï¼Œä½†ä¸€èˆ¬åœ¨æœ¬åœ°æ–‡ä»¶è¿è¡Œæ˜¯å…è®¸çš„
        console.warn('æ— æ³•è®¿é—®åƒç´ æ•°æ®', err);
      }
    }

    function revealAll(){
      if(revealed) return;
      revealed = true;
      // å¹³æ»‘æ·¡å‡ºè¦†ç›–å±‚
      canvas.style.transition = 'opacity 600ms ease';
      canvas.style.opacity = '0';
      setTimeout(()=>{
        canvas.remove();
        status.textContent = 'å·²å…¨éƒ¨æ­æ™“';
      }, 650);
    }

    // ç»‘å®šäº‹ä»¶ï¼ˆæ”¯æŒ pointer eventsï¼‰
    canvas.addEventListener('pointerdown', pointerDown);
    window.addEventListener('pointerup', pointerUp);
    canvas.addEventListener('pointermove', draw);

    // è§¦å±å…¼å®¹ï¼šprevent default æ»‘åŠ¨
    canvas.addEventListener('touchstart', e=>e.preventDefault(), {passive:false});

    // æŒ‰é’®
    resetBtn.addEventListener('click', ()=>{
      // é‡ç½®
      revealed = false;
      if(!document.body.contains(canvas)){
        // é‡æ–°æ’å…¥ canvas
        const newCanvas = document.createElement('canvas');
        newCanvas.id = 'mask';
        newCanvas.style.position = 'absolute';
        newCanvas.style.inset = '0';
        newCanvas.style.width = '100%';
        newCanvas.style.height = '100%';
        newCanvas.style.borderRadius = '8px';
        card.appendChild(newCanvas);
        // é‡æ–°ç»‘å®šå˜é‡ä¸äº‹ä»¶
        canvas = document.getElementById('mask');
        ctx = canvas.getContext('2d');
        canvas.addEventListener('pointerdown', pointerDown);
        window.addEventListener('pointerup', pointerUp);
        canvas.addEventListener('pointermove', draw);
      }
      pickPrize();
      resizeCanvas();
      canvas.style.opacity = '1';
      status.textContent = 'å·²åˆ®å¼€ï¼š0%';
    });

    revealBtn.addEventListener('click', ()=>{
      revealAll();
    });

    // åˆå§‹åŒ–
    pickPrize();
    // resize after DOM and fonts
    window.addEventListener('load', ()=>{ resizeCanvas(); });
    window.addEventListener('resize', ()=>{ resizeCanvas(); });

    // é˜²æ­¢å˜é‡è¦†ç›–é—®é¢˜ - ä¼˜é›…æ–¹å¼é‡æ–°è·å¾—å¼•ç”¨
    (function bindCanvasRefs(){
      // å°† canvasã€ctx å¯å˜
      let c = document.getElementById('mask');
      if(!c){
        c = document.createElement('canvas');
        c.id = 'mask';
        card.appendChild(c);
      }
    })();
  </script>
</body>
</html>